<!DOCTYPE html>
<html>
<head>
  <title>File Pairs Upload</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <h1>Select File Pairs</h1>

  <!-- Buttons above table -->
  <div class="button-row">
    <div class="left-buttons">
      <form id="addRowForm" method="POST">
        <button type="button" id="add-row">Add another file pair</button>
      </form>

      <form id="uploadSubmitForm" method="POST" enctype="multipart/form-data" action="/">
        <button type="submit" form="uploadForm">Upload & Run AI</button>
      </form>

      <form id="clearAllForm" method="post" action="/clear_all_data">
        <button type="submit">Clear All Data</button>
      </form>
    </div>
  </div>

  <!-- File upload table -->
  <form id="uploadForm" method="POST" enctype="multipart/form-data">
    <table id="file-pairs-table">
      <thead>
        <tr>
          <th>File A</th>
          <th>File B</th>
          <th>Comparison</th>
          <th>Items</th>
        </tr>
      </thead>
      <tbody>
        {% for i in range(filenamesA|length) %}
        <tr>
          <td>
            <label class="file-label">
              <input type="file" name="fileA[]">
              <span>{{ filenamesA[i] if filenamesA[i] else "Choose file" }}</span>
            </label>
            {% if results[i] and results[i].fileA %}
            <details>
              <summary>Show JSON A</summary>
              <pre>{{ results[i].fileA | tojson(indent=2) }}</pre>
            </details>
            {% endif %}
          </td>

          <td>
            <label class="file-label">
              <input type="file" name="fileB[]">
              <span>{{ filenamesB[i] if filenamesB[i] else "Choose file" }}</span>
            </label>
            {% if results[i] and results[i].fileB %}
            <details>
              <summary>Show JSON B</summary>
              <pre>{{ results[i].fileB | tojson(indent=2) }}</pre>
            </details>
            {% endif %}
          </td>

          <td>
            {% if results[i] %}
              {% if results[i].items_same_size is not none %}
                <div><strong>Same number of items?</strong> {{ results[i].items_same_size }}</div>
              {% endif %}
              {% if results[i].largest_grand_total %}
                <div><strong>Largest Grand Total:</strong> {{ results[i].largest_grand_total }}</div>
              {% endif %}
            {% endif %}
          </td>

          <td>
            {% if results[i] and results[i].items_detail %}
              {{ results[i].items_detail }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

  <script>
    function attachFileListener(input) {
      input.addEventListener('change', function() {
        this.nextElementSibling.textContent = this.files[0]?.name || "Choose file";
      });
    }
    document.querySelectorAll('.file-label input[type="file"]').forEach(attachFileListener);

    document.getElementById("add-row").addEventListener("click", () => {
      const tableBody = document.getElementById("file-pairs-table").querySelector('tbody');
      const newRow = tableBody.insertRow();
      newRow.innerHTML = `
        <td>
          <label class="file-label"><input type="file" name="fileA[]"><span>Choose file</span></label>
          <details style="display:none;"><summary>Show JSON A</summary><pre></pre></details>
        </td>
        <td>
          <label class="file-label"><input type="file" name="fileB[]"><span>Choose file</span></label>
          <details style="display:none;"><summary>Show JSON B</summary><pre></pre></details>
        </td>
        <td></td>
        <td></td>
      `;
      newRow.querySelectorAll('.file-label input[type="file"]').forEach(attachFileListener);
    });
  </script>
</body>
</html>
